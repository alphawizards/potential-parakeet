<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quallamaggie Scanner | QuantDash</title>
    <style>
        :root {
            --bg-primary: #0a0a1a;
            --bg-secondary: #12122a;
            --bg-card: #1a1a3a;
            --accent: #00d4ff;
            --accent-alt: #7b68ee;
            --success: #00ff88;
            --danger: #ff4466;
            --warning: #ffaa00;
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0;
            --border: #2a2a4a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            padding: 20px 40px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }

        .logo span {
            color: var(--text-primary);
        }

        nav {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        nav a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        nav a:hover,
        nav a.active {
            color: var(--accent);
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-ready {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
        }

        .status-scanning {
            background: rgba(255, 170, 0, 0.2);
            color: var(--warning);
        }

        .btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-alt) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Main Layout */
        main {
            padding: 30px 40px;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Page Title */
        .page-title {
            margin-bottom: 30px;
        }

        .page-title h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .page-title p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Filter Criteria Cards */
        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }

        .criteria-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .criteria-title {
            color: var(--accent);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .criteria-title-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-all-btn {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(0, 212, 255, 0.1);
            color: var(--accent);
            border: 1px solid var(--accent);
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-all-btn:hover {
            background: rgba(0, 212, 255, 0.2);
        }

        .criteria-list {
            list-style: none;
        }

        /* Interactive Filter Toggle */
        .filter-toggle {
            font-size: 13px;
            padding: 8px 12px;
            margin: 4px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .filter-toggle:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--border);
        }

        .filter-toggle.active {
            color: var(--text-primary);
            background: rgba(0, 255, 136, 0.08);
        }

        .filter-toggle.inactive {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .filter-toggle .toggle-icon {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .filter-toggle.active .toggle-icon {
            background: var(--success);
            color: #000;
        }

        .filter-toggle.inactive .toggle-icon {
            background: var(--border);
            color: var(--text-secondary);
        }

        .filter-toggle .filter-label {
            flex: 1;
        }

        /* Stats Row */
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px 30px;
            border: 1px solid var(--border);
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        /* Results Table */
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--accent);
            border-radius: 2px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .results-table th {
            background: var(--bg-secondary);
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--accent);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            user-select: none;
        }

        .results-table th:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .results-table th.sorted-asc::after {
            content: ' ‚Üë';
        }

        .results-table th.sorted-desc::after {
            content: ' ‚Üì';
        }

        .results-table td {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .results-table tr:last-child td {
            border-bottom: none;
        }

        .results-table tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .ticker-cell {
            font-weight: 700;
            color: var(--accent);
            font-size: 15px;
        }

        .positive {
            color: var(--success);
        }

        .negative {
            color: var(--danger);
        }

        .neutral {
            color: var(--text-secondary);
        }

        .signal-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .signal-buy {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
        }

        .signal-watch {
            background: rgba(255, 170, 0, 0.2);
            color: var(--warning);
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
            flex-direction: column;
            gap: 16px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* No Results */
        .no-results {
            text-align: center;
            padding: 60px;
            color: var(--text-secondary);
        }

        .no-results-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Universe Selector */
        .universe-selector {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .universe-selector label {
            color: var(--text-secondary);
            font-size: 13px;
            margin-right: 12px;
        }

        .universe-selector select {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .universe-selector select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .criteria-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 16px;
            }

            main {
                padding: 20px;
            }

            .criteria-grid {
                grid-template-columns: 1fr;
            }

            .stats-row {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">Quant<span>Dash</span></div>
        <nav>
            <a href="strategy_dashboard.html">üìä Dashboard</a>
            <a href="quallamaggie_scanner.html" class="active">üéØ Scanner</a>
            <a href="strategy_guide.html">üìö Strategy Guide</a>
        </nav>
        <div class="header-actions">
            <span class="status-badge status-ready" id="statusBadge">Ready</span>
            <button class="btn btn-primary" id="scanBtn" onclick="runScan()">üîç Run Scan</button>
        </div>
    </header>

    <main>
        <div class="page-title">
            <h1>üéØ Quallamaggie Momentum Scanner</h1>
            <p>Systematic screening based on Kristjan Kullam√§gi's swing trading criteria</p>
        </div>

        <!-- Filter Criteria -->
        <div class="criteria-grid">
            <div class="criteria-card">
                <div class="criteria-title">
                    <span class="criteria-title-left">üí∞ Liquidity</span>
                    <button class="toggle-all-btn" onclick="toggleCategory('liquidity')">‚òë All</button>
                </div>
                <div class="criteria-list">
                    <div class="filter-toggle active" data-category="liquidity" data-filter="price_min"
                        onclick="toggleFilter(this)">
                        <span class="toggle-icon">‚úì</span>
                        <span class="filter-label">Price ‚â• $1.00</span>
                    </div>
                    <div class="filter-toggle active" data-category="liquidity" data-filter="volume_20d"
                        onclick="toggleFilter(this)">
                        <span class="toggle-icon">‚úì</span>
                        <span class="filter-label">20D Avg $ Volume > $20M</span>
                    </div>
                </div>
            </div>
            <div class="criteria-card">
                <div class="criteria-title">
                    <span class="criteria-title-left">üöÄ Momentum</span>
                    <button class="toggle-all-btn" onclick="toggleCategory('momentum')">‚òë All</button>
                </div>
                <div class="criteria-list">
                    <div class="filter-toggle active" data-category="momentum" data-filter="ret_3m"
                        onclick="toggleFilter(this)">
                        <span class="toggle-icon">‚úì</span>
                        <span class="filter-label">3-Month Return ‚â• 30%</span>
                    </div>
                    <div class="filter-toggle active" data-category="momentum" data-filter="ret_1m"
                        onclick="toggleFilter(this)">
                        <span class="toggle-icon">‚úì</span>
                        <span class="filter-label">1-Month Return ‚â• 10%</span>
                    </div>
                    <div class="filter-toggle active" data-category="momentum" data-filter="rs_spy"
                        onclick="toggleFilter(this)">
                        <span class="toggle-icon">‚úì</span>
                        <span class="filter-label">Relative Strength > SPY</span>
                    </div>
                </div>
            </div>
            <div class="criteria-card">
                <div class="criteria-title">
                    <span class="criteria-title-left">üìà Trend</span>
                    <button class="toggle-all-btn" onclick="toggleCategory('trend')">‚òë All</button>
                </div>
                <div class="criteria-list">
                    <div class="filter-toggle active" data-category="trend" data-filter="sma_alignment"
                        onclick="toggleFilter(this)">
                        <span class="toggle-icon">‚úì</span>
                        <span class="filter-label">Close > SMA10 > SMA20 > SMA50</span>
                    </div>
                    <div class="filter-toggle active" data-category="trend" data-filter="above_sma200"
                        onclick="toggleFilter(this)">
                        <span class="toggle-icon">‚úì</span>
                        <span class="filter-label">Close > SMA200</span>
                    </div>
                    <div class="filter-toggle active" data-category="trend" data-filter="sma50_slope"
                        onclick="toggleFilter(this)">
                        <span class="toggle-icon">‚úì</span>
                        <span class="filter-label">SMA50 Slope Positive</span>
                    </div>
                </div>
            </div>
            <div class="criteria-card">
                <div class="criteria-title">
                    <span class="criteria-title-left">üéØ Consolidation</span>
                    <button class="toggle-all-btn" onclick="toggleCategory('consolidation')">‚òë All</button>
                </div>
                <div class="criteria-list">
                    <div class="filter-toggle active" data-category="consolidation" data-filter="near_high"
                        onclick="toggleFilter(this)">
                        <span class="toggle-icon">‚úì</span>
                        <span class="filter-label">Price ‚â• 85% of 126D High</span>
                    </div>
                    <div class="filter-toggle active" data-category="consolidation" data-filter="atr_contraction"
                        onclick="toggleFilter(this)">
                        <span class="toggle-icon">‚úì</span>
                        <span class="filter-label">ATR(14) < 20D Avg ATR</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Universe Selector -->
        <div class="universe-selector">
            <label for="universeSelect">Scan Universe:</label>
            <select id="universeSelect">
                <option value="sp500">S&P 500 (US)</option>
                <option value="nasdaq100">NASDAQ 100 (US)</option>
                <option value="asx200">ASX 200 (Australia)</option>
                <option value="momentum">Momentum Leaders</option>
                <option value="custom">Custom (Top ETFs)</option>
            </select>
            <span style="color: var(--text-secondary); margin-left: 20px; font-size: 13px;" id="universeInfo">
                Loading...
            </span>
        </div>

        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-value" id="totalScanned">--</div>
                <div class="stat-label">Stocks Scanned</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="passedFilters">--</div>
                <div class="stat-label">Passed All Filters</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="avgMomentum">--</div>
                <div class="stat-label">Avg 3M Momentum</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="scanTime">--</div>
                <div class="stat-label">Last Scan</div>
            </div>
        </div>

        <!-- Results Table -->
        <h2 class="section-title">Scan Results</h2>
        <table class="results-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Ticker</th>
                    <th onclick="sortTable(1)">Price</th>
                    <th onclick="sortTable(2)">Vol 20D Avg</th>
                    <th onclick="sortTable(3)">3M Return</th>
                    <th onclick="sortTable(4)">1M Return</th>
                    <th onclick="sortTable(5)">RS vs SPY</th>
                    <th onclick="sortTable(6)">% from 126D High</th>
                    <th onclick="sortTable(7)">ATR Contraction</th>
                    <th onclick="sortTable(8)">Signal</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
                <tr>
                    <td colspan="9" class="no-results">
                        <div class="no-results-icon">üîç</div>
                        <div>Click "Run Scan" to screen for Quallamaggie setups</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </main>

    <script>
        // Data Source Configuration
        const DATA_SOURCES = {
            US: 'tiingo',      // Tiingo for US stocks (S&P 500, NASDAQ 100)
            AU: 'norgate'      // Norgate for Australian stocks (ASX 200)
        };

        // S&P 500 Components (Full list - 503 stocks as of Dec 2024)
        const SP500_TICKERS = [
            // Information Technology
            'AAPL', 'MSFT', 'NVDA', 'AVGO', 'ORCL', 'CRM', 'ADBE', 'ACN', 'CSCO', 'IBM',
            'INTC', 'AMD', 'TXN', 'QCOM', 'NOW', 'INTU', 'AMAT', 'ADI', 'LRCX', 'MU',
            'KLAC', 'SNPS', 'CDNS', 'APH', 'MSI', 'MCHP', 'TEL', 'FTNT', 'ON', 'ANSS',
            'KEYS', 'HPQ', 'GLW', 'FSLR', 'HPE', 'MPWR', 'ZBRA', 'GEN', 'SWKS', 'EPAM',
            'NTAP', 'JNPR', 'PTC', 'AKAM', 'WDC', 'FFIV', 'CTSH', 'IT', 'PAYC', 'ENPH',
            // Financials
            'JPM', 'V', 'MA', 'BAC', 'WFC', 'GS', 'MS', 'SPGI', 'AXP', 'BLK',
            'C', 'SCHW', 'CB', 'MMC', 'PGR', 'CME', 'AON', 'ICE', 'USB', 'MCO',
            'AJG', 'PNC', 'AFL', 'MET', 'TRV', 'PRU', 'ALL', 'AIG', 'TFC', 'AMP',
            'BK', 'MTB', 'CINF', 'FDS', 'MSCI', 'DFS', 'HBAN', 'RF', 'HIG', 'RJF',
            'WRB', 'CFG', 'KEY', 'FITB', 'STT', 'NTRS', 'SYF', 'L', 'ACGL', 'GL',
            // Health Care
            'UNH', 'LLY', 'JNJ', 'MRK', 'ABBV', 'TMO', 'ABT', 'DHR', 'PFE', 'AMGN',
            'BMY', 'ISRG', 'VRTX', 'SYK', 'ELV', 'GILD', 'MDT', 'BSX', 'CI', 'CVS',
            'REGN', 'MCK', 'HUM', 'BDX', 'ZTS', 'COR', 'EW', 'IDXX', 'A', 'GEHC',
            'IQV', 'DXCM', 'MTD', 'CAH', 'BAX', 'RMD', 'HOLX', 'WAT', 'TFX', 'ALGN',
            'PODD', 'LH', 'MOH', 'CNC', 'BIIB', 'DGX', 'VTRS', 'TECH', 'HSIC', 'INCY',
            // Consumer Discretionary
            'AMZN', 'TSLA', 'HD', 'MCD', 'NKE', 'LOW', 'SBUX', 'TJX', 'CMG', 'BKNG',
            'ORLY', 'AZO', 'MAR', 'YUM', 'HLT', 'RCL', 'GM', 'F', 'DHI', 'LEN',
            'ROST', 'DPZ', 'LVS', 'MGM', 'WYNN', 'APTV', 'EBAY', 'ULTA', 'GRMN', 'NVR',
            'BBY', 'GPC', 'DRI', 'PHM', 'POOL', 'TSCO', 'CZR', 'BWA', 'TPR', 'KMX',
            'CCL', 'NCLH', 'HAS', 'RL', 'LKQ', 'MHK', 'VFC', 'EXPE', 'LULU', 'DECK',
            // Communication Services
            'GOOGL', 'GOOG', 'META', 'NFLX', 'DIS', 'CMCSA', 'T', 'VZ', 'CHTR', 'TMUS',
            'EA', 'MTCH', 'WBD', 'OMC', 'TTWO', 'PARA', 'IPG', 'LYV', 'FOX', 'FOXA',
            'NWSA', 'NWS',
            // Consumer Staples
            'PG', 'COST', 'WMT', 'KO', 'PEP', 'PM', 'MDLZ', 'CL', 'MO', 'EL',
            'KMB', 'GIS', 'SYY', 'STZ', 'KDP', 'HSY', 'KHC', 'TSN', 'ADM', 'MKC',
            'CAG', 'CLX', 'K', 'CHD', 'HRL', 'TAP', 'SJM', 'CPB', 'LW', 'BG',
            'KR', 'WBA', 'TGT',
            // Industrials
            'GE', 'CAT', 'RTX', 'HON', 'UNP', 'BA', 'UPS', 'DE', 'LMT', 'ADP',
            'ETN', 'GD', 'ITW', 'WM', 'CSX', 'NSC', 'FDX', 'PH', 'EMR', 'NOC',
            'CTAS', 'CARR', 'JCI', 'GWW', 'ODFL', 'PCAR', 'FAST', 'MMM', 'SNA', 'LHX',
            'HWM', 'ROK', 'TXT', 'URI', 'VRSK', 'DAL', 'PWR', 'TDG', 'XYL', 'AME',
            'CPRT', 'WAB', 'IR', 'EFX', 'LDOS', 'IEX', 'GNRC', 'SWK', 'ALLE', 'AOS',
            'UAL', 'LUV', 'J', 'MAS', 'BR', 'HUBB', 'RHI', 'HII', 'NDSN', 'CHRW',
            // Energy
            'XOM', 'CVX', 'COP', 'SLB', 'EOG', 'MPC', 'PSX', 'VLO', 'OXY', 'PXD',
            'HES', 'DVN', 'HAL', 'BKR', 'FANG', 'WMB', 'KMI', 'OKE', 'TRGP', 'LNG',
            'APA', 'CTRA', 'EQT', 'MRO',
            // Materials
            'LIN', 'APD', 'SHW', 'FCX', 'NEM', 'NUE', 'ECL', 'VMC', 'MLM', 'DOW',
            'DD', 'PPG', 'IFF', 'BALL', 'IP', 'PKG', 'AVY', 'CF', 'ALB', 'FMC',
            'MOS', 'CE', 'EMN', 'CTVA', 'AMCR', 'SEE',
            // Utilities
            'NEE', 'DUK', 'SO', 'D', 'AEP', 'EXC', 'SRE', 'XEL', 'ED', 'PEG',
            'PCG', 'CEG', 'EIX', 'WEC', 'AWK', 'ES', 'ETR', 'DTE', 'FE', 'AEE',
            'CMS', 'CNP', 'NI', 'EVRG', 'ATO', 'LNT', 'NRG', 'PPL', 'PNW',
            // Real Estate
            'PLD', 'AMT', 'EQIX', 'CCI', 'PSA', 'O', 'WELL', 'SPG', 'DLR', 'AVB',
            'EQR', 'VTR', 'ARE', 'SBAC', 'ESS', 'MAA', 'INVH', 'EXR', 'WY', 'UDR',
            'VICI', 'HST', 'CBRE', 'KIM', 'REG', 'BXP', 'DOC', 'IRM', 'CPT', 'FRT'
        ];

        // NASDAQ 100 Components (Full list - 101 stocks as of Dec 2024)
        const NASDAQ100_TICKERS = [
            'AAPL', 'MSFT', 'NVDA', 'AMZN', 'META', 'AVGO', 'GOOGL', 'GOOG', 'TSLA', 'COST',
            'NFLX', 'AMD', 'ADBE', 'QCOM', 'PEP', 'CSCO', 'LIN', 'TMUS', 'TXN', 'INTU',
            'AMGN', 'CMCSA', 'ISRG', 'HON', 'AMAT', 'BKNG', 'VRTX', 'ADP', 'REGN', 'GILD',
            'PANW', 'MU', 'ADI', 'SBUX', 'MDLZ', 'LRCX', 'MELI', 'KLAC', 'CHTR', 'SNPS',
            'CDNS', 'PYPL', 'CTAS', 'MAR', 'CRWD', 'ORLY', 'CEG', 'ABNB', 'WDAY', 'CSX',
            'NXPI', 'ROP', 'PCAR', 'MNST', 'MRVL', 'ADSK', 'AEP', 'MCHP', 'ODFL', 'FTNT',
            'KDP', 'PAYX', 'CPRT', 'AZN', 'ROST', 'KHC', 'DXCM', 'LULU', 'FAST', 'EXC',
            'GEHC', 'EA', 'VRSK', 'IDXX', 'BKR', 'CDW', 'CTSH', 'ON', 'DDOG', 'FANG',
            'ANSS', 'TTWO', 'XEL', 'BIIB', 'ZS', 'GFS', 'TEAM', 'ILMN', 'WBD', 'DLTR',
            'MDB', 'SMCI', 'ARM', 'PLTR', 'NET', 'DASH', 'COIN', 'TTD', 'ZM', 'ROKU',
            'OKTA'
        ];

        // ASX 200 Components (Top 200 Australian stocks by market cap)
        const ASX200_TICKERS = [
            // Banks & Financials
            'CBA.AX', 'NAB.AX', 'WBC.AX', 'ANZ.AX', 'MQG.AX', 'QBE.AX', 'SUN.AX', 'IAG.AX',
            'ASX.AX', 'BEN.AX', 'BOQ.AX', 'AMP.AX', 'PPT.AX', 'HUB.AX', 'NWL.AX', 'CGF.AX',
            'JHG.AX', 'MFG.AX', 'PDL.AX', 'IFL.AX',
            // Mining & Resources
            'BHP.AX', 'RIO.AX', 'FMG.AX', 'NCM.AX', 'NST.AX', 'EVN.AX', 'NHC.AX', 'WHC.AX',
            'S32.AX', 'MIN.AX', 'PLS.AX', 'LTR.AX', 'IGO.AX', 'OZL.AX', 'SFR.AX', 'ILU.AX',
            'AWC.AX', 'BSL.AX', 'CIA.AX', 'AKE.AX', 'LYC.AX', 'RRL.AX', 'GOR.AX', 'SLR.AX',
            'CMM.AX', 'DEG.AX', 'WAF.AX', 'RED.AX', 'PRU.AX', 'NIC.AX',
            // Energy
            'WDS.AX', 'STO.AX', 'ORG.AX', 'WOR.AX', 'APA.AX', 'AGL.AX', 'VEA.AX', 'COE.AX',
            'KAR.AX', 'BPT.AX', 'BOE.AX', 'PDN.AX', 'TLS.AX', 'SGP.AX', 'CVN.AX', 'NHF.AX',
            // Healthcare
            'CSL.AX', 'RMD.AX', 'COH.AX', 'SHL.AX', 'PME.AX', 'FPH.AX', 'RHC.AX', 'ANN.AX',
            'CAR.AX', 'EVT.AX', 'MPL.AX', 'HLS.AX', 'IFM.AX', 'EML.AX', 'PRN.AX', 'IMU.AX',
            'NAN.AX', 'PNV.AX', 'NEA.AX', 'TLX.AX',
            // Consumer & Retail
            'WES.AX', 'WOW.AX', 'COL.AX', 'JBH.AX', 'HVN.AX', 'SUL.AX', 'LOV.AX', 'PMV.AX',
            'CWY.AX', 'BRG.AX', 'WEB.AX', 'ALL.AX', 'JIN.AX', 'TAH.AX', 'TWE.AX', 'A2M.AX',
            'CCL.AX', 'BAP.AX', 'MTS.AX', 'ELD.AX',
            // Real Estate
            'GMG.AX', 'GPT.AX', 'MGR.AX', 'SCG.AX', 'VCX.AX', 'NSR.AX', 'CHC.AX', 'DXS.AX',
            'CIP.AX', 'CLW.AX', 'CQR.AX', 'BWP.AX', 'ABP.AX', 'HMC.AX', 'ARF.AX', 'GMF.AX',
            // Technology
            'XRO.AX', 'WTC.AX', 'REA.AX', 'CAR.AX', 'SEK.AX', 'NXT.AX', 'TNE.AX', 'CPU.AX',
            'APX.AX', 'MP1.AX', 'IRE.AX', 'EML.AX', 'DDR.AX', 'PME.AX', 'FCL.AX', 'ALU.AX',
            // Industrials
            'TCL.AX', 'BXB.AX', 'SYD.AX', 'AZJ.AX', 'QAN.AX', 'QUB.AX', 'CTD.AX', 'DOW.AX',
            'IEL.AX', 'IPL.AX', 'SGM.AX', 'ALQ.AX', 'ORA.AX', 'WOR.AX', 'RWC.AX', 'NWH.AX',
            'ALX.AX', 'AIA.AX', 'REH.AX', 'CVW.AX',
            // Telecoms & Media
            'TPG.AX', 'NEC.AX', 'REH.AX', 'SXL.AX', 'SPK.AX', 'NWS.AX', 'OML.AX', 'SWM.AX',
            // Utilities
            'AGL.AX', 'APA.AX', 'SKI.AX', 'NWH.AX', 'ORG.AX', 'CEN.AX', 'MEZ.AX', 'AST.AX',
            // Other
            'TCL.AX', 'RMD.AX', 'AMC.AX', 'BLD.AX', 'LLC.AX', 'ORI.AX', 'IPH.AX', 'ING.AX',
            'IVC.AX', 'AVN.AX', 'FLT.AX', 'IDP.AX', 'JHX.AX', 'RHC.AX', 'TPW.AX', 'VNT.AX',
            'APE.AX', 'AUB.AX', 'BKW.AX', 'BSA.AX', 'EBO.AX', 'GNC.AX', 'HUM.AX', 'INA.AX',
            'LNK.AX', 'MAQ.AX', 'MVP.AX', 'NWL.AX', 'PNI.AX', 'SGF.AX', 'TYR.AX', 'VEA.AX'
        ];

        // Momentum Leaders (Active momentum plays)
        const MOMENTUM_TICKERS = [
            'NVDA', 'AMD', 'SMCI', 'PLTR', 'META', 'AVGO', 'ORCL', 'CRM', 'NOW', 'PANW',
            'CRWD', 'ZS', 'NET', 'DDOG', 'MDB', 'SNOW', 'COIN', 'MSTR', 'ARM', 'TSM',
            'NFLX', 'DASH', 'UBER', 'ABNB', 'LLY', 'NVO', 'ISRG', 'VRTX', 'MELI', 'TTD'
        ];

        // Combined universes
        const UNIVERSES = {
            sp500: SP500_TICKERS,
            nasdaq100: NASDAQ100_TICKERS,
            asx200: ASX200_TICKERS,
            momentum: MOMENTUM_TICKERS,
            custom: ['SPY', 'QQQ', 'IWM', 'XLK', 'XLF', 'XLE', 'XLV', 'XLY', 'SOXX', 'SMH',
                'ARKK', 'TAN', 'GLD', 'SLV', 'TLT', 'HYG', 'EEM', 'VWO', 'TQQQ', 'SOXL']
        };

        // Filter Configuration - tracks which filters are active
        const FILTER_CONFIG = {
            liquidity: {
                price_min: { active: true, value: 1 },
                volume_20d: { active: true, value: 20e6 }
            },
            momentum: {
                ret_3m: { active: true, value: 0.30 },
                ret_1m: { active: true, value: 0.10 },
                rs_spy: { active: true, value: 0 }
            },
            trend: {
                sma_alignment: { active: true },
                above_sma200: { active: true },
                sma50_slope: { active: true }
            },
            consolidation: {
                near_high: { active: true, value: 0.85 },
                atr_contraction: { active: true }
            }
        };

        // Toggle individual filter
        function toggleFilter(element) {
            const category = element.dataset.category;
            const filter = element.dataset.filter;

            // Toggle state
            FILTER_CONFIG[category][filter].active = !FILTER_CONFIG[category][filter].active;
            const isActive = FILTER_CONFIG[category][filter].active;

            // Update UI
            element.classList.toggle('active', isActive);
            element.classList.toggle('inactive', !isActive);
            element.querySelector('.toggle-icon').textContent = isActive ? '‚úì' : '‚úó';

            // Auto re-scan
            runScan();
        }

        // Toggle all filters in a category
        function toggleCategory(category) {
            const filters = FILTER_CONFIG[category];
            const allActive = Object.values(filters).every(f => f.active);
            const newState = !allActive;

            // Update config
            Object.keys(filters).forEach(key => {
                filters[key].active = newState;
            });

            // Update UI
            document.querySelectorAll(`.filter-toggle[data-category="${category}"]`).forEach(el => {
                el.classList.toggle('active', newState);
                el.classList.toggle('inactive', !newState);
                el.querySelector('.toggle-icon').textContent = newState ? '‚úì' : '‚úó';
            });

            // Auto re-scan
            runScan();
        }

        // Apply active filters to data
        function applyFilters(data) {
            return data.filter(stock => {
                // Liquidity filters
                if (FILTER_CONFIG.liquidity.price_min.active && stock.price < FILTER_CONFIG.liquidity.price_min.value) return false;
                if (FILTER_CONFIG.liquidity.volume_20d.active && stock.dollarVolume < FILTER_CONFIG.liquidity.volume_20d.value) return false;

                // Momentum filters
                if (FILTER_CONFIG.momentum.ret_3m.active && stock.ret_3m < FILTER_CONFIG.momentum.ret_3m.value) return false;
                if (FILTER_CONFIG.momentum.ret_1m.active && stock.ret_1m < FILTER_CONFIG.momentum.ret_1m.value) return false;
                if (FILTER_CONFIG.momentum.rs_spy.active && stock.rsVsSpy < FILTER_CONFIG.momentum.rs_spy.value) return false;

                // Trend filters (simplified for mock data)
                if (FILTER_CONFIG.trend.above_sma200.active && !stock.aboveSma200) return false;

                // Consolidation filters
                if (FILTER_CONFIG.consolidation.near_high.active && stock.pctFromHigh < FILTER_CONFIG.consolidation.near_high.value) return false;

                return true;
            });
        }

        // Count active filters
        function countActiveFilters() {
            let count = 0;
            Object.values(FILTER_CONFIG).forEach(category => {
                Object.values(category).forEach(filter => {
                    if (filter.active) count++;
                });
            });
            return count;
        }

        let currentSort = { column: 2, asc: false }; // Default sort by 3M return desc
        let scanResults = [];

        // Update universe info with data source
        function updateUniverseInfo(autoScan = false) {
            const select = document.getElementById('universeSelect');
            const universe = select.value;
            const count = UNIVERSES[universe].length;
            const dataSource = universe === 'asx200' ? DATA_SOURCES.AU : DATA_SOURCES.US;
            const sourceLabel = dataSource === 'tiingo' ? 'üá∫üá∏ Tiingo' : 'üá¶üá∫ Norgate';
            document.getElementById('universeInfo').textContent =
                `${count} stocks in universe | Data: ${sourceLabel}`;

            // Auto-scan when universe changes (but not on initial load)
            if (autoScan) {
                runScan();
            }
        }

        // When dropdown changes, update info AND run scan automatically
        document.getElementById('universeSelect').addEventListener('change', () => updateUniverseInfo(true));

        // Initialize on page load - update info and run initial scan
        document.addEventListener('DOMContentLoaded', () => {
            updateUniverseInfo(false);
            // Run initial scan after a short delay to ensure everything is loaded
            setTimeout(() => runScan(), 500);
        });

        async function runScan() {
            const btn = document.getElementById('scanBtn');
            const statusBadge = document.getElementById('statusBadge');
            const resultsBody = document.getElementById('resultsBody');
            const universe = document.getElementById('universeSelect').value;
            const tickers = UNIVERSES[universe];

            // Update UI
            btn.textContent = '‚è≥ Scanning...';
            btn.disabled = true;
            statusBadge.className = 'status-badge status-scanning';
            statusBadge.textContent = 'Scanning...';

            resultsBody.innerHTML = `
                <tr>
                    <td colspan="8" class="loading">
                        <div class="spinner"></div>
                        <div class="loading-text">Fetching data for ${tickers.length} stocks...</div>
                    </td>
                </tr>
            `;

            try {
                // Simulate API call - in production this would call a backend
                const results = await performLocalScan(tickers);
                scanResults = results;

                // Update stats
                document.getElementById('totalScanned').textContent = tickers.length;
                document.getElementById('passedFilters').textContent = results.length;

                if (results.length > 0) {
                    const avgMom = results.reduce((sum, r) => sum + r.ret_3m, 0) / results.length;
                    document.getElementById('avgMomentum').textContent = (avgMom * 100).toFixed(1) + '%';
                } else {
                    document.getElementById('avgMomentum').textContent = '--';
                }

                document.getElementById('scanTime').textContent = new Date().toLocaleTimeString();

                // Render results
                renderResults(results);

            } catch (error) {
                console.error('Scan error:', error);
                resultsBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-results" style="color: var(--danger);">
                            <div class="no-results-icon">‚ö†Ô∏è</div>
                            <div>Scan failed: ${error.message}</div>
                        </td>
                    </tr>
                `;
            } finally {
                btn.textContent = 'üîç Run Scan';
                btn.disabled = false;
                statusBadge.className = 'status-badge status-ready';
                statusBadge.textContent = 'Ready';
            }
        }

        async function performLocalScan(tickers) {
            // Get current universe for filtering
            const universe = document.getElementById('universeSelect').value;
            const universeTickers = new Set(UNIVERSES[universe]);
            const activeFilterCount = countActiveFilters();

            // For demo mode: always generate mock data for the full universe
            // This ensures filters work correctly on complete dataset
            // API/backend integration would replace this with real data
            console.log(`Generating mock data for ${universe} (${tickers.length} stocks, ${activeFilterCount} filters active)`);

            // Generate universe-specific mock data (most realistic fallback)
            console.log(`Generating mock scan data for ${universe} with ${tickers.length} tickers (${activeFilterCount} filters active)`);
            const mockData = generateMockData(tickers);

            // Apply active filters dynamically based on toggle state
            const filtered = applyFilters(mockData);

            // Sort by momentum
            filtered.sort((a, b) => b.ret_3m - a.ret_3m);

            // Limit results: show more when fewer filters are active
            // All filters off = show all stocks (up to 500 for performance)
            // Some filters on = show top matching results (up to 100)
            const maxResults = activeFilterCount === 0 ? 500 : 100;
            const topResults = filtered.slice(0, maxResults);

            // Map to expected format
            return topResults.map(stock => ({
                ticker: stock.ticker,
                price: stock.price,
                dollarVolume: stock.dollarVolume,
                ret_3m: stock.ret_3m,
                ret_1m: stock.ret_1m,
                rs_vs_spy: stock.rsVsSpy,
                pct_from_high: stock.pctFromHigh,
                atr_contraction: stock.atrContraction,
                signal: stock.perfectAlignment && stock.ret_3m > 0.30 ? 'STRONG' : 'WATCH'
            }));
        }

        function generateMockData(tickers) {
            // Generate realistic mock data for demonstration
            // Data is generated to allow each filter to independently filter the universe

            const highMomentum = [
                // US Tech leaders
                'NVDA', 'SMCI', 'PLTR', 'META', 'AMD', 'AVGO', 'ARM', 'COIN', 'MSTR', 'CRWD',
                // ASX momentum leaders
                'XRO.AX', 'WTC.AX', 'PME.AX', 'REA.AX', 'CSL.AX', 'FMG.AX', 'BHP.AX'
            ];
            const moderateMomentum = [
                // US large caps
                'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'CRM', 'NOW', 'PANW', 'ZS', 'ORCL', 'NFLX', 'ADBE',
                // ASX blue chips
                'CBA.AX', 'NAB.AX', 'WBC.AX', 'ANZ.AX', 'MQG.AX', 'WES.AX', 'WOW.AX', 'RIO.AX', 'NCM.AX',
                // ETFs
                'SPY', 'QQQ', 'IWM', 'XLK', 'SOXX', 'SMH'
            ];

            return tickers.map(ticker => {
                // Check if ticker (with or without .AX) is in momentum lists
                const tickerClean = ticker.replace('.AX', '');
                const isHighMom = highMomentum.includes(ticker) || highMomentum.includes(tickerClean);
                const isModMom = moderateMomentum.includes(ticker) || moderateMomentum.includes(tickerClean);

                // Generate 3-month return with realistic distribution
                // ~40% of stocks should have 30%+ 3M return
                let ret_3m;
                if (isHighMom) {
                    ret_3m = 0.40 + Math.random() * 0.60;  // 40-100%
                } else if (isModMom) {
                    ret_3m = 0.20 + Math.random() * 0.40;  // 20-60%
                } else {
                    // General population: wide distribution
                    // ~40% positive, ~30% above 30%
                    ret_3m = -0.20 + Math.random() * 0.70;  // -20% to +50%
                }

                // Generate 1-month return independently
                // ~50% of stocks should have 10%+ 1M return
                let ret_1m;
                if (isHighMom) {
                    ret_1m = 0.12 + Math.random() * 0.25;  // 12-37%
                } else if (isModMom) {
                    ret_1m = 0.05 + Math.random() * 0.20;  // 5-25%
                } else {
                    // General population: ~50% above 10%
                    ret_1m = -0.10 + Math.random() * 0.35;  // -10% to +25%
                }

                // Generate price: ~90% should pass $1 filter
                const price = isHighMom || isModMom
                    ? 50 + Math.random() * 400  // $50-450
                    : 0.5 + Math.random() * 300;  // $0.50-300

                // Generate volume: ~60% should pass $20M filter
                const dollarVolume = isHighMom
                    ? (50 + Math.random() * 500) * 1e6   // $50M-550M
                    : isModMom
                        ? (30 + Math.random() * 200) * 1e6  // $30M-230M
                        : (5 + Math.random() * 100) * 1e6;  // $5M-105M (some below $20M)

                // Generate % from high: ~60% should be within 15% of high
                const pctFromHigh = isHighMom
                    ? 0.90 + Math.random() * 0.10  // 90-100%
                    : isModMom
                        ? 0.80 + Math.random() * 0.20  // 80-100%
                        : 0.65 + Math.random() * 0.35;  // 65-100%

                // RS vs SPY: tied to absolute return minus market
                const rsVsSpy = ret_3m - 0.05;  // Assume SPY +5% baseline

                return {
                    ticker: ticker,
                    price: price,
                    dollarVolume: dollarVolume,
                    ret_3m: ret_3m,
                    ret_1m: ret_1m,
                    rsVsSpy: rsVsSpy,
                    pctFromHigh: pctFromHigh,
                    atrContraction: Math.random() > 0.4,  // 60% pass
                    perfectAlignment: Math.random() > 0.5,  // 50% pass
                    aboveSma200: ret_3m > 0 ? true : Math.random() > 0.4  // Positive stocks mostly above SMA200
                };
            });
        }

        function renderResults(results) {
            const tbody = document.getElementById('resultsBody');

            if (results.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="no-results">
                            <div class="no-results-icon">üîç</div>
                            <div>No stocks passed all filters. Run: <code>python -m strategy.quallamaggie_scanner</code></div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Format volume for display (e.g., 25M, 150M)
            function formatVolume(vol) {
                if (!vol || vol === 0) return '--';
                if (vol >= 1e9) return (vol / 1e9).toFixed(1) + 'B';
                if (vol >= 1e6) return (vol / 1e6).toFixed(1) + 'M';
                if (vol >= 1e3) return (vol / 1e3).toFixed(1) + 'K';
                return vol.toFixed(0);
            }

            tbody.innerHTML = results.map(stock => `
                <tr>
                    <td class="ticker-cell">${stock.ticker}</td>
                    <td>$${stock.price.toFixed(2)}</td>
                    <td>${formatVolume(stock.dollarVolume || stock.volume20d)}</td>
                    <td class="${stock.ret_3m >= 0.30 ? 'positive' : 'neutral'}">${(stock.ret_3m * 100).toFixed(1)}%</td>
                    <td class="${stock.ret_1m >= 0.10 ? 'positive' : 'neutral'}">${(stock.ret_1m * 100).toFixed(1)}%</td>
                    <td class="${stock.rs_vs_spy > 0 ? 'positive' : 'negative'}">${stock.rs_vs_spy > 0 ? '+' : ''}${(stock.rs_vs_spy * 100).toFixed(1)}%</td>
                    <td class="${stock.pct_from_high >= 0.90 ? 'positive' : 'neutral'}">${(stock.pct_from_high * 100).toFixed(1)}%</td>
                    <td>${stock.atr_contraction ? '<span class="positive">‚úì Yes</span>' : '<span class="negative">‚úó No</span>'}</td>
                    <td><span class="signal-badge ${stock.signal === 'STRONG' ? 'signal-buy' : 'signal-watch'}">${stock.signal}</span></td>
                </tr>
            `).join('');
        }

        function sortTable(columnIndex) {
            const headers = document.querySelectorAll('.results-table th');

            // Update sort direction
            if (currentSort.column === columnIndex) {
                currentSort.asc = !currentSort.asc;
            } else {
                currentSort.column = columnIndex;
                currentSort.asc = false; // Default descending for new column
            }

            // Update header classes
            headers.forEach((h, i) => {
                h.classList.remove('sorted-asc', 'sorted-desc');
                if (i === columnIndex) {
                    h.classList.add(currentSort.asc ? 'sorted-asc' : 'sorted-desc');
                }
            });

            // Column index to data key mapping (matches current table structure)
            // 0: Ticker, 1: Price, 2: Vol 20D, 3: 3M Return, 4: 1M Return, 
            // 5: RS vs SPY, 6: % from High, 7: ATR Contraction, 8: Signal
            const sortKeys = [
                'ticker',           // 0
                'price',            // 1
                'dollarVolume',     // 2
                'ret_3m',           // 3
                'ret_1m',           // 4
                'rs_vs_spy',        // 5
                'pct_from_high',    // 6
                'atr_contraction',  // 7
                'signal'            // 8
            ];
            const key = sortKeys[columnIndex];

            if (!key) return;

            scanResults.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                // Handle null/undefined
                if (valA === undefined || valA === null) valA = currentSort.asc ? Infinity : -Infinity;
                if (valB === undefined || valB === null) valB = currentSort.asc ? Infinity : -Infinity;

                // String comparison (for ticker and signal)
                if (typeof valA === 'string') {
                    return currentSort.asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }

                // Boolean comparison (for atr_contraction)
                if (typeof valA === 'boolean') {
                    valA = valA ? 1 : 0;
                    valB = valB ? 1 : 0;
                }

                // Numeric comparison
                return currentSort.asc ? valA - valB : valB - valA;
            });

            renderResults(scanResults);
        }
    </script>
</body>

</html>