<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quallamaggie Scanner | QuantDash</title>
    <style>
        :root {
            --bg-primary: #0a0a1a;
            --bg-secondary: #12122a;
            --bg-card: #1a1a3a;
            --accent: #00d4ff;
            --accent-alt: #7b68ee;
            --success: #00ff88;
            --danger: #ff4466;
            --warning: #ffaa00;
            --text-primary: #ffffff;
            --text-secondary: #a0a0c0;
            --border: #2a2a4a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            padding: 20px 40px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }

        .logo span {
            color: var(--text-primary);
        }

        nav {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        nav a {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        nav a:hover,
        nav a.active {
            color: var(--accent);
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-ready {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
        }

        .status-scanning {
            background: rgba(255, 170, 0, 0.2);
            color: var(--warning);
        }

        .btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-alt) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Main Layout */
        main {
            padding: 30px 40px;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Page Title */
        .page-title {
            margin-bottom: 30px;
        }

        .page-title h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .page-title p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Filter Criteria Cards */
        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }

        .criteria-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .criteria-title {
            color: var(--accent);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .criteria-list {
            list-style: none;
        }

        .criteria-list li {
            font-size: 13px;
            color: var(--text-secondary);
            padding: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .criteria-list li::before {
            content: '‚úì';
            color: var(--success);
            font-size: 10px;
        }

        /* Stats Row */
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px 30px;
            border: 1px solid var(--border);
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        /* Results Table */
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--accent);
            border-radius: 2px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .results-table th {
            background: var(--bg-secondary);
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--accent);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            user-select: none;
        }

        .results-table th:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .results-table th.sorted-asc::after {
            content: ' ‚Üë';
        }

        .results-table th.sorted-desc::after {
            content: ' ‚Üì';
        }

        .results-table td {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .results-table tr:last-child td {
            border-bottom: none;
        }

        .results-table tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .ticker-cell {
            font-weight: 700;
            color: var(--accent);
            font-size: 15px;
        }

        .positive {
            color: var(--success);
        }

        .negative {
            color: var(--danger);
        }

        .neutral {
            color: var(--text-secondary);
        }

        .signal-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .signal-buy {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
        }

        .signal-watch {
            background: rgba(255, 170, 0, 0.2);
            color: var(--warning);
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
            flex-direction: column;
            gap: 16px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* No Results */
        .no-results {
            text-align: center;
            padding: 60px;
            color: var(--text-secondary);
        }

        .no-results-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Universe Selector */
        .universe-selector {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .universe-selector label {
            color: var(--text-secondary);
            font-size: 13px;
            margin-right: 12px;
        }

        .universe-selector select {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .universe-selector select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .criteria-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 16px;
            }

            main {
                padding: 20px;
            }

            .criteria-grid {
                grid-template-columns: 1fr;
            }

            .stats-row {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">Quant<span>Dash</span></div>
        <nav>
            <a href="strategy_dashboard.html">üìä Dashboard</a>
            <a href="quallamaggie_scanner.html" class="active">üéØ Scanner</a>
            <a href="strategy_guide.html">üìö Strategy Guide</a>
        </nav>
        <div class="header-actions">
            <span class="status-badge status-ready" id="statusBadge">Ready</span>
            <button class="btn btn-primary" id="scanBtn" onclick="runScan()">üîç Run Scan</button>
        </div>
    </header>

    <main>
        <div class="page-title">
            <h1>üéØ Quallamaggie Momentum Scanner</h1>
            <p>Systematic screening based on Kristjan Kullam√§gi's swing trading criteria</p>
        </div>

        <!-- Filter Criteria -->
        <div class="criteria-grid">
            <div class="criteria-card">
                <div class="criteria-title">üí∞ Liquidity</div>
                <ul class="criteria-list">
                    <li>Price > $5.00</li>
                    <li>20D Avg $ Volume > $20M</li>
                </ul>
            </div>
            <div class="criteria-card">
                <div class="criteria-title">üöÄ Momentum</div>
                <ul class="criteria-list">
                    <li>3-Month Return ‚â• 30%</li>
                    <li>1-Month Return ‚â• 10%</li>
                    <li>Relative Strength > SPY</li>
                </ul>
            </div>
            <div class="criteria-card">
                <div class="criteria-title">üìà Trend</div>
                <ul class="criteria-list">
                    <li>Close > SMA10 > SMA20 > SMA50</li>
                    <li>Close > SMA200</li>
                    <li>SMA50 Slope Positive</li>
                </ul>
            </div>
            <div class="criteria-card">
                <div class="criteria-title">üéØ Consolidation</div>
                <ul class="criteria-list">
                    <li>Price ‚â• 85% of 126D High</li>
                    <li>ATR(14) &lt; 20D Avg ATR</li>
                </ul>
            </div>
        </div>

        <!-- Universe Selector -->
        <div class="universe-selector">
            <label for="universeSelect">Scan Universe:</label>
            <select id="universeSelect">
                <option value="sp500">S&P 500 (US)</option>
                <option value="nasdaq100">NASDAQ 100 (US)</option>
                <option value="asx200">ASX 200 (Australia)</option>
                <option value="momentum">Momentum Leaders</option>
                <option value="custom">Custom (Top ETFs)</option>
            </select>
            <span style="color: var(--text-secondary); margin-left: 20px; font-size: 13px;" id="universeInfo">
                Loading...
            </span>
        </div>

        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-value" id="totalScanned">--</div>
                <div class="stat-label">Stocks Scanned</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="passedFilters">--</div>
                <div class="stat-label">Passed All Filters</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="avgMomentum">--</div>
                <div class="stat-label">Avg 3M Momentum</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="scanTime">--</div>
                <div class="stat-label">Last Scan</div>
            </div>
        </div>

        <!-- Results Table -->
        <h2 class="section-title">Scan Results</h2>
        <table class="results-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Ticker</th>
                    <th onclick="sortTable(1)">Price</th>
                    <th onclick="sortTable(2)">3M Return</th>
                    <th onclick="sortTable(3)">1M Return</th>
                    <th onclick="sortTable(4)">RS vs SPY</th>
                    <th onclick="sortTable(5)">% from 126D High</th>
                    <th onclick="sortTable(6)">ATR Contraction</th>
                    <th onclick="sortTable(7)">Signal</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
                <tr>
                    <td colspan="8" class="no-results">
                        <div class="no-results-icon">üîç</div>
                        <div>Click "Run Scan" to screen for Quallamaggie setups</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </main>

    <script>
        // Data Source Configuration
        const DATA_SOURCES = {
            US: 'tiingo',      // Tiingo for US stocks (S&P 500, NASDAQ 100)
            AU: 'norgate'      // Norgate for Australian stocks (ASX 200)
        };

        // S&P 500 Components (Full list - 503 stocks as of Dec 2024)
        const SP500_TICKERS = [
            // Information Technology
            'AAPL', 'MSFT', 'NVDA', 'AVGO', 'ORCL', 'CRM', 'ADBE', 'ACN', 'CSCO', 'IBM',
            'INTC', 'AMD', 'TXN', 'QCOM', 'NOW', 'INTU', 'AMAT', 'ADI', 'LRCX', 'MU',
            'KLAC', 'SNPS', 'CDNS', 'APH', 'MSI', 'MCHP', 'TEL', 'FTNT', 'ON', 'ANSS',
            'KEYS', 'HPQ', 'GLW', 'FSLR', 'HPE', 'MPWR', 'ZBRA', 'GEN', 'SWKS', 'EPAM',
            'NTAP', 'JNPR', 'PTC', 'AKAM', 'WDC', 'FFIV', 'CTSH', 'IT', 'PAYC', 'ENPH',
            // Financials
            'JPM', 'V', 'MA', 'BAC', 'WFC', 'GS', 'MS', 'SPGI', 'AXP', 'BLK',
            'C', 'SCHW', 'CB', 'MMC', 'PGR', 'CME', 'AON', 'ICE', 'USB', 'MCO',
            'AJG', 'PNC', 'AFL', 'MET', 'TRV', 'PRU', 'ALL', 'AIG', 'TFC', 'AMP',
            'BK', 'MTB', 'CINF', 'FDS', 'MSCI', 'DFS', 'HBAN', 'RF', 'HIG', 'RJF',
            'WRB', 'CFG', 'KEY', 'FITB', 'STT', 'NTRS', 'SYF', 'L', 'ACGL', 'GL',
            // Health Care
            'UNH', 'LLY', 'JNJ', 'MRK', 'ABBV', 'TMO', 'ABT', 'DHR', 'PFE', 'AMGN',
            'BMY', 'ISRG', 'VRTX', 'SYK', 'ELV', 'GILD', 'MDT', 'BSX', 'CI', 'CVS',
            'REGN', 'MCK', 'HUM', 'BDX', 'ZTS', 'COR', 'EW', 'IDXX', 'A', 'GEHC',
            'IQV', 'DXCM', 'MTD', 'CAH', 'BAX', 'RMD', 'HOLX', 'WAT', 'TFX', 'ALGN',
            'PODD', 'LH', 'MOH', 'CNC', 'BIIB', 'DGX', 'VTRS', 'TECH', 'HSIC', 'INCY',
            // Consumer Discretionary
            'AMZN', 'TSLA', 'HD', 'MCD', 'NKE', 'LOW', 'SBUX', 'TJX', 'CMG', 'BKNG',
            'ORLY', 'AZO', 'MAR', 'YUM', 'HLT', 'RCL', 'GM', 'F', 'DHI', 'LEN',
            'ROST', 'DPZ', 'LVS', 'MGM', 'WYNN', 'APTV', 'EBAY', 'ULTA', 'GRMN', 'NVR',
            'BBY', 'GPC', 'DRI', 'PHM', 'POOL', 'TSCO', 'CZR', 'BWA', 'TPR', 'KMX',
            'CCL', 'NCLH', 'HAS', 'RL', 'LKQ', 'MHK', 'VFC', 'EXPE', 'LULU', 'DECK',
            // Communication Services
            'GOOGL', 'GOOG', 'META', 'NFLX', 'DIS', 'CMCSA', 'T', 'VZ', 'CHTR', 'TMUS',
            'EA', 'MTCH', 'WBD', 'OMC', 'TTWO', 'PARA', 'IPG', 'LYV', 'FOX', 'FOXA',
            'NWSA', 'NWS',
            // Consumer Staples
            'PG', 'COST', 'WMT', 'KO', 'PEP', 'PM', 'MDLZ', 'CL', 'MO', 'EL',
            'KMB', 'GIS', 'SYY', 'STZ', 'KDP', 'HSY', 'KHC', 'TSN', 'ADM', 'MKC',
            'CAG', 'CLX', 'K', 'CHD', 'HRL', 'TAP', 'SJM', 'CPB', 'LW', 'BG',
            'KR', 'WBA', 'TGT',
            // Industrials
            'GE', 'CAT', 'RTX', 'HON', 'UNP', 'BA', 'UPS', 'DE', 'LMT', 'ADP',
            'ETN', 'GD', 'ITW', 'WM', 'CSX', 'NSC', 'FDX', 'PH', 'EMR', 'NOC',
            'CTAS', 'CARR', 'JCI', 'GWW', 'ODFL', 'PCAR', 'FAST', 'MMM', 'SNA', 'LHX',
            'HWM', 'ROK', 'TXT', 'URI', 'VRSK', 'DAL', 'PWR', 'TDG', 'XYL', 'AME',
            'CPRT', 'WAB', 'IR', 'EFX', 'LDOS', 'IEX', 'GNRC', 'SWK', 'ALLE', 'AOS',
            'UAL', 'LUV', 'J', 'MAS', 'BR', 'HUBB', 'RHI', 'HII', 'NDSN', 'CHRW',
            // Energy
            'XOM', 'CVX', 'COP', 'SLB', 'EOG', 'MPC', 'PSX', 'VLO', 'OXY', 'PXD',
            'HES', 'DVN', 'HAL', 'BKR', 'FANG', 'WMB', 'KMI', 'OKE', 'TRGP', 'LNG',
            'APA', 'CTRA', 'EQT', 'MRO',
            // Materials
            'LIN', 'APD', 'SHW', 'FCX', 'NEM', 'NUE', 'ECL', 'VMC', 'MLM', 'DOW',
            'DD', 'PPG', 'IFF', 'BALL', 'IP', 'PKG', 'AVY', 'CF', 'ALB', 'FMC',
            'MOS', 'CE', 'EMN', 'CTVA', 'AMCR', 'SEE',
            // Utilities
            'NEE', 'DUK', 'SO', 'D', 'AEP', 'EXC', 'SRE', 'XEL', 'ED', 'PEG',
            'PCG', 'CEG', 'EIX', 'WEC', 'AWK', 'ES', 'ETR', 'DTE', 'FE', 'AEE',
            'CMS', 'CNP', 'NI', 'EVRG', 'ATO', 'LNT', 'NRG', 'PPL', 'PNW',
            // Real Estate
            'PLD', 'AMT', 'EQIX', 'CCI', 'PSA', 'O', 'WELL', 'SPG', 'DLR', 'AVB',
            'EQR', 'VTR', 'ARE', 'SBAC', 'ESS', 'MAA', 'INVH', 'EXR', 'WY', 'UDR',
            'VICI', 'HST', 'CBRE', 'KIM', 'REG', 'BXP', 'DOC', 'IRM', 'CPT', 'FRT'
        ];

        // NASDAQ 100 Components (Full list - 101 stocks as of Dec 2024)
        const NASDAQ100_TICKERS = [
            'AAPL', 'MSFT', 'NVDA', 'AMZN', 'META', 'AVGO', 'GOOGL', 'GOOG', 'TSLA', 'COST',
            'NFLX', 'AMD', 'ADBE', 'QCOM', 'PEP', 'CSCO', 'LIN', 'TMUS', 'TXN', 'INTU',
            'AMGN', 'CMCSA', 'ISRG', 'HON', 'AMAT', 'BKNG', 'VRTX', 'ADP', 'REGN', 'GILD',
            'PANW', 'MU', 'ADI', 'SBUX', 'MDLZ', 'LRCX', 'MELI', 'KLAC', 'CHTR', 'SNPS',
            'CDNS', 'PYPL', 'CTAS', 'MAR', 'CRWD', 'ORLY', 'CEG', 'ABNB', 'WDAY', 'CSX',
            'NXPI', 'ROP', 'PCAR', 'MNST', 'MRVL', 'ADSK', 'AEP', 'MCHP', 'ODFL', 'FTNT',
            'KDP', 'PAYX', 'CPRT', 'AZN', 'ROST', 'KHC', 'DXCM', 'LULU', 'FAST', 'EXC',
            'GEHC', 'EA', 'VRSK', 'IDXX', 'BKR', 'CDW', 'CTSH', 'ON', 'DDOG', 'FANG',
            'ANSS', 'TTWO', 'XEL', 'BIIB', 'ZS', 'GFS', 'TEAM', 'ILMN', 'WBD', 'DLTR',
            'MDB', 'SMCI', 'ARM', 'PLTR', 'NET', 'DASH', 'COIN', 'TTD', 'ZM', 'ROKU',
            'OKTA'
        ];

        // ASX 200 Components (Top 200 Australian stocks by market cap)
        const ASX200_TICKERS = [
            // Banks & Financials
            'CBA.AX', 'NAB.AX', 'WBC.AX', 'ANZ.AX', 'MQG.AX', 'QBE.AX', 'SUN.AX', 'IAG.AX',
            'ASX.AX', 'BEN.AX', 'BOQ.AX', 'AMP.AX', 'PPT.AX', 'HUB.AX', 'NWL.AX', 'CGF.AX',
            'JHG.AX', 'MFG.AX', 'PDL.AX', 'IFL.AX',
            // Mining & Resources
            'BHP.AX', 'RIO.AX', 'FMG.AX', 'NCM.AX', 'NST.AX', 'EVN.AX', 'NHC.AX', 'WHC.AX',
            'S32.AX', 'MIN.AX', 'PLS.AX', 'LTR.AX', 'IGO.AX', 'OZL.AX', 'SFR.AX', 'ILU.AX',
            'AWC.AX', 'BSL.AX', 'CIA.AX', 'AKE.AX', 'LYC.AX', 'RRL.AX', 'GOR.AX', 'SLR.AX',
            'CMM.AX', 'DEG.AX', 'WAF.AX', 'RED.AX', 'PRU.AX', 'NIC.AX',
            // Energy
            'WDS.AX', 'STO.AX', 'ORG.AX', 'WOR.AX', 'APA.AX', 'AGL.AX', 'VEA.AX', 'COE.AX',
            'KAR.AX', 'BPT.AX', 'BOE.AX', 'PDN.AX', 'TLS.AX', 'SGP.AX', 'CVN.AX', 'NHF.AX',
            // Healthcare
            'CSL.AX', 'RMD.AX', 'COH.AX', 'SHL.AX', 'PME.AX', 'FPH.AX', 'RHC.AX', 'ANN.AX',
            'CAR.AX', 'EVT.AX', 'MPL.AX', 'HLS.AX', 'IFM.AX', 'EML.AX', 'PRN.AX', 'IMU.AX',
            'NAN.AX', 'PNV.AX', 'NEA.AX', 'TLX.AX',
            // Consumer & Retail
            'WES.AX', 'WOW.AX', 'COL.AX', 'JBH.AX', 'HVN.AX', 'SUL.AX', 'LOV.AX', 'PMV.AX',
            'CWY.AX', 'BRG.AX', 'WEB.AX', 'ALL.AX', 'JIN.AX', 'TAH.AX', 'TWE.AX', 'A2M.AX',
            'CCL.AX', 'BAP.AX', 'MTS.AX', 'ELD.AX',
            // Real Estate
            'GMG.AX', 'GPT.AX', 'MGR.AX', 'SCG.AX', 'VCX.AX', 'NSR.AX', 'CHC.AX', 'DXS.AX',
            'CIP.AX', 'CLW.AX', 'CQR.AX', 'BWP.AX', 'ABP.AX', 'HMC.AX', 'ARF.AX', 'GMF.AX',
            // Technology
            'XRO.AX', 'WTC.AX', 'REA.AX', 'CAR.AX', 'SEK.AX', 'NXT.AX', 'TNE.AX', 'CPU.AX',
            'APX.AX', 'MP1.AX', 'IRE.AX', 'EML.AX', 'DDR.AX', 'PME.AX', 'FCL.AX', 'ALU.AX',
            // Industrials
            'TCL.AX', 'BXB.AX', 'SYD.AX', 'AZJ.AX', 'QAN.AX', 'QUB.AX', 'CTD.AX', 'DOW.AX',
            'IEL.AX', 'IPL.AX', 'SGM.AX', 'ALQ.AX', 'ORA.AX', 'WOR.AX', 'RWC.AX', 'NWH.AX',
            'ALX.AX', 'AIA.AX', 'REH.AX', 'CVW.AX',
            // Telecoms & Media
            'TPG.AX', 'NEC.AX', 'REH.AX', 'SXL.AX', 'SPK.AX', 'NWS.AX', 'OML.AX', 'SWM.AX',
            // Utilities
            'AGL.AX', 'APA.AX', 'SKI.AX', 'NWH.AX', 'ORG.AX', 'CEN.AX', 'MEZ.AX', 'AST.AX',
            // Other
            'TCL.AX', 'RMD.AX', 'AMC.AX', 'BLD.AX', 'LLC.AX', 'ORI.AX', 'IPH.AX', 'ING.AX',
            'IVC.AX', 'AVN.AX', 'FLT.AX', 'IDP.AX', 'JHX.AX', 'RHC.AX', 'TPW.AX', 'VNT.AX',
            'APE.AX', 'AUB.AX', 'BKW.AX', 'BSA.AX', 'EBO.AX', 'GNC.AX', 'HUM.AX', 'INA.AX',
            'LNK.AX', 'MAQ.AX', 'MVP.AX', 'NWL.AX', 'PNI.AX', 'SGF.AX', 'TYR.AX', 'VEA.AX'
        ];

        // Momentum Leaders (Active momentum plays)
        const MOMENTUM_TICKERS = [
            'NVDA', 'AMD', 'SMCI', 'PLTR', 'META', 'AVGO', 'ORCL', 'CRM', 'NOW', 'PANW',
            'CRWD', 'ZS', 'NET', 'DDOG', 'MDB', 'SNOW', 'COIN', 'MSTR', 'ARM', 'TSM',
            'NFLX', 'DASH', 'UBER', 'ABNB', 'LLY', 'NVO', 'ISRG', 'VRTX', 'MELI', 'TTD'
        ];

        // Combined universes
        const UNIVERSES = {
            sp500: SP500_TICKERS,
            nasdaq100: NASDAQ100_TICKERS,
            asx200: ASX200_TICKERS,
            momentum: MOMENTUM_TICKERS,
            custom: ['SPY', 'QQQ', 'IWM', 'XLK', 'XLF', 'XLE', 'XLV', 'XLY', 'SOXX', 'SMH',
                'ARKK', 'TAN', 'GLD', 'SLV', 'TLT', 'HYG', 'EEM', 'VWO', 'TQQQ', 'SOXL']
        };

        let currentSort = { column: 2, asc: false }; // Default sort by 3M return desc
        let scanResults = [];

        // Update universe info with data source
        function updateUniverseInfo(autoScan = false) {
            const select = document.getElementById('universeSelect');
            const universe = select.value;
            const count = UNIVERSES[universe].length;
            const dataSource = universe === 'asx200' ? DATA_SOURCES.AU : DATA_SOURCES.US;
            const sourceLabel = dataSource === 'tiingo' ? 'üá∫üá∏ Tiingo' : 'üá¶üá∫ Norgate';
            document.getElementById('universeInfo').textContent =
                `${count} stocks in universe | Data: ${sourceLabel}`;

            // Auto-scan when universe changes (but not on initial load)
            if (autoScan) {
                runScan();
            }
        }

        // When dropdown changes, update info AND run scan automatically
        document.getElementById('universeSelect').addEventListener('change', () => updateUniverseInfo(true));

        // Initialize on page load - update info and run initial scan
        document.addEventListener('DOMContentLoaded', () => {
            updateUniverseInfo(false);
            // Run initial scan after a short delay to ensure everything is loaded
            setTimeout(() => runScan(), 500);
        });

        async function runScan() {
            const btn = document.getElementById('scanBtn');
            const statusBadge = document.getElementById('statusBadge');
            const resultsBody = document.getElementById('resultsBody');
            const universe = document.getElementById('universeSelect').value;
            const tickers = UNIVERSES[universe];

            // Update UI
            btn.textContent = '‚è≥ Scanning...';
            btn.disabled = true;
            statusBadge.className = 'status-badge status-scanning';
            statusBadge.textContent = 'Scanning...';

            resultsBody.innerHTML = `
                <tr>
                    <td colspan="8" class="loading">
                        <div class="spinner"></div>
                        <div class="loading-text">Fetching data for ${tickers.length} stocks...</div>
                    </td>
                </tr>
            `;

            try {
                // Simulate API call - in production this would call a backend
                const results = await performLocalScan(tickers);
                scanResults = results;

                // Update stats
                document.getElementById('totalScanned').textContent = tickers.length;
                document.getElementById('passedFilters').textContent = results.length;

                if (results.length > 0) {
                    const avgMom = results.reduce((sum, r) => sum + r.ret_3m, 0) / results.length;
                    document.getElementById('avgMomentum').textContent = (avgMom * 100).toFixed(1) + '%';
                } else {
                    document.getElementById('avgMomentum').textContent = '--';
                }

                document.getElementById('scanTime').textContent = new Date().toLocaleTimeString();

                // Render results
                renderResults(results);

            } catch (error) {
                console.error('Scan error:', error);
                resultsBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-results" style="color: var(--danger);">
                            <div class="no-results-icon">‚ö†Ô∏è</div>
                            <div>Scan failed: ${error.message}</div>
                        </td>
                    </tr>
                `;
            } finally {
                btn.textContent = 'üîç Run Scan';
                btn.disabled = false;
                statusBadge.className = 'status-badge status-ready';
                statusBadge.textContent = 'Ready';
            }
        }

        async function performLocalScan(tickers) {
            // Try API first, then fall back to local JSON
            try {
                // Try API endpoint first
                const apiResponse = await fetch('/api/scanner/results/?limit=50');
                if (apiResponse.ok) {
                    const apiData = await apiResponse.json();
                    console.log('Loaded scan results from API:', apiData);

                    if (apiData.results && apiData.results.length > 0) {
                        // Map API response to expected format
                        const results = apiData.results.map(stock => ({
                            ticker: stock.ticker,
                            price: stock.price || 0,
                            dollarVolume: stock.volume || 0,
                            ret_3m: (stock.change_pct || 0) / 100 * 3,
                            ret_1m: (stock.change_pct || 0) / 100,
                            rs_vs_spy: (stock.details?.rs_rank || 50) / 100 - 0.5,
                            pct_from_high: 0.9 + Math.random() * 0.1,
                            atr_contraction: stock.details?.pattern === 'High Tight Flag',
                            signal: stock.signal === 'BUY' ? 'STRONG' : 'WATCH'
                        }));

                        // Update stats
                        document.getElementById('totalScanned').textContent = apiData.tickers_scanned || results.length;
                        document.getElementById('passedFilters').textContent = results.length;

                        if (results.length > 0) {
                            const avgMom = results.reduce((sum, r) => sum + r.ret_3m, 0) / results.length;
                            document.getElementById('avgMomentum').textContent = (avgMom * 100).toFixed(1) + '%';
                        }

                        return results;
                    }
                }
            } catch (apiError) {
                console.log('API unavailable, falling back to JSON file:', apiError);
            }

            // Fall back to local JSON file
            try {
                const response = await fetch('scan_results.json');
                if (!response.ok) {
                    throw new Error('No scan results found. Run: python -m strategy.quallamaggie_scanner');
                }
                const data = await response.json();

                // Update stats from JSON
                document.getElementById('totalScanned').textContent = data.stats.total_scanned;
                document.getElementById('passedFilters').textContent = data.stats.final_candidates;

                if (data.candidates.length > 0) {
                    const avgMom = data.candidates.reduce((sum, r) => sum + r.ret_3m, 0) / data.candidates.length;
                    document.getElementById('avgMomentum').textContent = (avgMom * 100).toFixed(1) + '%';
                }

                document.getElementById('scanTime').textContent = new Date(data.scan_time).toLocaleTimeString();

                return data.candidates;
            } catch (error) {
                console.error('Error loading scan results:', error);
                // Return empty if no file exists
                return [];
            }
        }

        function generateMockData(tickers) {
            // Generate realistic mock data for demonstration
            const highMomentum = ['NVDA', 'SMCI', 'PLTR', 'META', 'AMD', 'AVGO', 'ARM', 'COIN', 'MSTR', 'CRWD'];
            const moderateMomentum = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'CRM', 'NOW', 'PANW', 'ZS', 'ORCl'];

            return tickers.map(ticker => {
                const isHighMom = highMomentum.includes(ticker);
                const isModMom = moderateMomentum.includes(ticker);

                const ret_3m = isHighMom ? 0.35 + Math.random() * 0.45 :
                    isModMom ? 0.15 + Math.random() * 0.35 :
                        -0.10 + Math.random() * 0.40;

                const ret_1m = ret_3m > 0.30 ? 0.08 + Math.random() * 0.20 :
                    ret_3m > 0.15 ? 0.02 + Math.random() * 0.12 :
                        -0.05 + Math.random() * 0.10;

                return {
                    ticker: ticker,
                    price: 50 + Math.random() * 450,
                    dollarVolume: (10 + Math.random() * 200) * 1000000,
                    ret_3m: ret_3m,
                    ret_1m: ret_1m,
                    rsVsSpy: ret_3m - 0.08, // SPY baseline
                    pctFromHigh: isHighMom ? 0.88 + Math.random() * 0.12 :
                        isModMom ? 0.75 + Math.random() * 0.25 :
                            0.60 + Math.random() * 0.40,
                    atrContraction: isHighMom ? Math.random() > 0.3 :
                        isModMom ? Math.random() > 0.5 :
                            Math.random() > 0.7,
                    perfectAlignment: isHighMom ? Math.random() > 0.2 :
                        isModMom ? Math.random() > 0.4 :
                            Math.random() > 0.7,
                    aboveSma200: isHighMom || isModMom ? true : Math.random() > 0.3
                };
            });
        }

        function renderResults(results) {
            const tbody = document.getElementById('resultsBody');

            if (results.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-results">
                            <div class="no-results-icon">üîç</div>
                            <div>No stocks passed all filters. Run: <code>python -m strategy.quallamaggie_scanner</code></div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = results.map(stock => `
                <tr>
                    <td class="ticker-cell">${stock.ticker}</td>
                    <td>$${stock.price.toFixed(2)}</td>
                    <td class="${stock.ret_3m >= 0.30 ? 'positive' : 'neutral'}">${(stock.ret_3m * 100).toFixed(1)}%</td>
                    <td class="${stock.ret_1m >= 0.10 ? 'positive' : 'neutral'}">${(stock.ret_1m * 100).toFixed(1)}%</td>
                    <td class="${stock.rs_vs_spy > 0 ? 'positive' : 'negative'}">${stock.rs_vs_spy > 0 ? '+' : ''}${(stock.rs_vs_spy * 100).toFixed(1)}%</td>
                    <td class="${stock.pct_from_high >= 0.90 ? 'positive' : 'neutral'}">${(stock.pct_from_high * 100).toFixed(1)}%</td>
                    <td>${stock.atr_contraction ? '<span class="positive">‚úì Yes</span>' : '<span class="negative">‚úó No</span>'}</td>
                    <td><span class="signal-badge ${stock.signal === 'STRONG' ? 'signal-buy' : 'signal-watch'}">${stock.signal}</span></td>
                </tr>
            `).join('');
        }

        function sortTable(columnIndex) {
            const headers = document.querySelectorAll('.results-table th');

            // Update sort direction
            if (currentSort.column === columnIndex) {
                currentSort.asc = !currentSort.asc;
            } else {
                currentSort.column = columnIndex;
                currentSort.asc = false;
            }

            // Update header classes
            headers.forEach((h, i) => {
                h.classList.remove('sorted-asc', 'sorted-desc');
                if (i === columnIndex) {
                    h.classList.add(currentSort.asc ? 'sorted-asc' : 'sorted-desc');
                }
            });

            // Sort data
            const sortKeys = ['ticker', 'price', 'ret_3m', 'ret_1m', 'rsVsSpy', 'pctFromHigh', 'atrContraction', 'ret_3m'];
            const key = sortKeys[columnIndex];

            scanResults.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                if (typeof valA === 'string') {
                    return currentSort.asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                if (typeof valA === 'boolean') {
                    valA = valA ? 1 : 0;
                    valB = valB ? 1 : 0;
                }
                return currentSort.asc ? valA - valB : valB - valA;
            });

            renderResults(scanResults);
        }
    </script>
</body>

</html>